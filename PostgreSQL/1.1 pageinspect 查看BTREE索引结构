pageinspect 查看BTREE索引结构

1. 添加pageinspect拓展
    create extension pageinspect;
    
2. 创建测试表，并创建一个多列组合索引
    select count(1) from tb_bloom_c;
    +----------+
    |  count   |
    +----------+
    | 10000000 |
    +----------+
    (1 row)
    
    postgres@[local]:5432 test# \d+ tb_bloom_c
                       Table "public.tb_bloom_c"
    +--------+---------+-----------+---------+--------------+-------------+
    | Column |  Type   | Modifiers | Storage | Stats target | Description |
    +--------+---------+-----------+---------+--------------+-------------+
    | i1     | integer |           | plain   |              |             |
    | i2     | integer |           | plain   |              |             |
    | i3     | integer |           | plain   |              |             |
    | i4     | integer |           | plain   |              |             |
    | i5     | integer |           | plain   |              |             |
    | i6     | integer |           | plain   |              |             |
    | i7     | integer |           | plain   |              |             |
    | i8     | integer |           | plain   |              |             |
    | i9     | integer |           | plain   |              |             |
    | i10    | integer |           | plain   |              |             |
    +--------+---------+-----------+---------+--------------+-------------+
    Indexes:
        "btreeidx_i38" btree (i3, i8)
        
    postgres@[local]:5432 test# \di+ btreeidx_i38
                               List of relations
    +--------+--------------+-------+----------+------------+--------+-------------+
    | Schema |     Name     | Type  |  Owner   |   Table    |  Size  | Description |
    +--------+--------------+-------+----------+------------+--------+-------------+
    | public | btreeidx_i38 | index | postgres | tb_bloom_c | 214 MB |             |
    +--------+--------------+-------+----------+------------+--------+-------------+
    (1 row)
    
3. BTREE索引结构
    BTREE索引结构包含四部分，meta page、root page、branch page和leaf page.
    在一个索引结构中meta page和root page是必须存在的。
            *-----------*
            | meta page |           一个页来存储，只想root page的page id
            *-----------*
                  |
            *-----------*
            | root page |           
            *-----------*           0级结构（只有meta page和root page）
                  |
           *-------------*
           | branch page |          1级结构
           *-------------*          2级结构
                .....                 ...
                  |                 n级结构
            *-----------*
            | leaf page |
            *-----------*
            
4. 利用pageinspect拓展包来剖析BTREE索引
    查看索引概况：
        postgres@[local]:5432 test# select * from bt_metap('btreeidx_i38');
        +--------+---------+------+-------+----------+-----------+
        | magic  | version | root | level | fastroot | fastlevel |
        +--------+---------+------+-------+----------+-----------+
        | 340322 |       2 |  290 |     2 |      290 |         2 |
        +--------+---------+------+-------+----------+-----------+
        (1 row)
        由上述结果：root=290 表示root 的page id=290
                   level=2  表示为2级结构（即4种page都刚好存在）
                   
    查看索引root page概要信息：
        postgres@[local]:5432 test# select * from bt_page_stats('btreeidx_i38',290);
        +-------+------+------------+------------+---------------+-----------+-----------+-----------+-----------+------+------------+
        | blkno | type | live_items | dead_items | avg_item_size | page_size | free_size | btpo_prev | btpo_next | btpo | btpo_flags |
        +-------+------+------------+------------+---------------+-----------+-----------+-----------+-----------+------+------------+
        |   290 | r    |         97 |          0 |            15 |      8192 |      6216 |         0 |         0 |    2 |          2 |
        +-------+------+------------+------------+---------------+-----------+-----------+-----------+-----------+------+------------+
        (1 row)
        有上述结果：btpo=2 表示该页还不到最底层，（最底层为btpo=0 即该页中存储的ctid为heap page的地址）
                   btpo_flags=2 表示该页是root page
                   live_items=97 表示该root page指向97个branch page
                   
    查看索引root page指向的详细信息：
        postgres@[local]:5432 test# select * from bt_page_items('btreeidx_i38',290) limit 10;
        +------------+----------+---------+-------+------+-------------------------+
        | itemoffset |   ctid   | itemlen | nulls | vars |          data           |
        +------------+----------+---------+-------+------+-------------------------+
        |          1 | (3,1)    |       8 | f     | f    |                         |
        |          2 | (289,1)  |      16 | f     | f    | 87 28 00 00 54 c3 06 00 |
        |          3 | (575,1)  |      16 | f     | f    | dd 50 00 00 a9 84 0a 00 |
        |          4 | (860,1)  |      16 | f     | f    | 88 79 00 00 a7 86 02 00 |
        |          5 | (1145,1) |      16 | f     | f    | ee a1 00 00 ed 1a 0d 00 |
        |          6 | (1430,1) |      16 | f     | f    | 9c ca 00 00 ac cf 04 00 |
        |          7 | (1715,1) |      16 | f     | f    | 74 f3 00 00 de cb 01 00 |
        |          8 | (2000,1) |      16 | f     | f    | 37 1c 01 00 90 38 08 00 |
        |          9 | (2285,1) |      16 | f     | f    | 83 44 01 00 83 43 0b 00 |
        |         10 | (2570,1) |      16 | f     | f    | 48 6d 01 00 a6 67 06 00 |
        +------------+----------+---------+-------+------+-------------------------+
        (10 rows)
        上述结果中，第一个branch page id为289
        
     查看branch page概要信息：
        postgres@[local]:5432 test# select * from bt_page_stats('btreeidx_i38',289);
        +-------+------+------------+------------+---------------+-----------+-----------+-----------+-----------+------+------------+
        | blkno | type | live_items | dead_items | avg_item_size | page_size | free_size | btpo_prev | btpo_next | btpo | btpo_flags |
        +-------+------+------------+------------+---------------+-----------+-----------+-----------+-----------+------+------------+
        |   289 | i    |        285 |          0 |            15 |      8192 |      2456 |         3 |       575 |    1 |          0 |
        +-------+------+------------+------------+---------------+-----------+-----------+-----------+-----------+------+------------+
        (1 row)
        由上述结果得：btpo=1  表示还不到最底层
                     btpo_flags=0  表示该页为branch page
                     live_items=285  表示该页指向285个下一层级page
                     
     查看branch page详细内容：
        postgres@[local]:5432 test# select * from bt_page_items('btreeidx_i38',289) limit 10;
        +------------+---------+---------+-------+------+-------------------------+
        | itemoffset |  ctid   | itemlen | nulls | vars |          data           |
        +------------+---------+---------+-------+------+-------------------------+
        |          1 | (572,1) |      16 | f     | f    | dd 50 00 00 a9 84 0a 00 |
        |          2 | (286,1) |       8 | f     | f    |                         |
        |          3 | (287,1) |      16 | f     | f    | aa 28 00 00 80 61 09 00 |
        |          4 | (288,1) |      16 | f     | f    | cf 28 00 00 3f 96 03 00 |
        |          5 | (291,1) |      16 | f     | f    | f2 28 00 00 74 5b 00 00 |
        |          6 | (292,1) |      16 | f     | f    | 17 29 00 00 41 4a 00 00 |
        |          7 | (293,1) |      16 | f     | f    | 3d 29 00 00 60 ed 01 00 |
        |          8 | (294,1) |      16 | f     | f    | 5f 29 00 00 65 54 0a 00 |
        |          9 | (295,1) |      16 | f     | f    | 80 29 00 00 9e 52 0c 00 |
        |         10 | (296,1) |      16 | f     | f    | a2 29 00 00 d3 bc 0a 00 |
        +------------+---------+---------+-------+------+-------------------------+
        ！！！
        NOTICE：所有branch page的起始item对应的data都是空的
        所以 下一层的page id=287
        
    查看下一层的概况：
        postgres@[local]:5432 test# select * from bt_page_stats('btreeidx_i38',287);
        +-------+------+------------+------------+---------------+-----------+-----------+-----------+-----------+------+------------+
        | blkno | type | live_items | dead_items | avg_item_size | page_size | free_size | btpo_prev | btpo_next | btpo | btpo_flags |
        +-------+------+------------+------------+---------------+-----------+-----------+-----------+-----------+------+------------+
        |   287 | l    |        367 |          0 |            16 |      8192 |       808 |       286 |       288 |    0 |          1 |
        +-------+------+------------+------------+---------------+-----------+-----------+-----------+-----------+------+------------+
        (1 row)
        由上述结果：btpo=0   表示已经是最底层
                   btpo_flags = 1   表示该页是leaf page
    
    查看该leaf page的详细信息：
        postgres@[local]:5432 test# select * from bt_page_items('btreeidx_i38',287) limit 10;
        +------------+-------------+---------+-------+------+-------------------------+
        | itemoffset |    ctid     | itemlen | nulls | vars |          data           |
        +------------+-------------+---------+-------+------+-------------------------+
        |          1 | (50008,111) |      16 | f     | f    | cf 28 00 00 3f 96 03 00 |
        |          2 | (38417,10)  |      16 | f     | f    | aa 28 00 00 80 61 09 00 |
        |          3 | (60548,18)  |      16 | f     | f    | aa 28 00 00 bd 45 0a 00 |
        |          4 | (8664,116)  |      16 | f     | f    | aa 28 00 00 d3 58 0a 00 |
        |          5 | (8043,120)  |      16 | f     | f    | aa 28 00 00 51 2d 0b 00 |
        |          6 | (51381,30)  |      16 | f     | f    | aa 28 00 00 de 79 0b 00 |
        |          7 | (75787,45)  |      16 | f     | f    | aa 28 00 00 21 38 0e 00 |
        |          8 | (57061,59)  |      16 | f     | f    | aa 28 00 00 c1 51 0e 00 |
        |          9 | (12993,71)  |      16 | f     | f    | aa 28 00 00 4f e0 0e 00 |
        |         10 | (42131,119) |      16 | f     | f    | ab 28 00 00 a5 f8 00 00 |
        +------------+-------------+---------+-------+------+-------------------------+
        (10 rows)
        从btpo=0 该层可以得到heap page id,
        如第一行 ctid=(50008,111) 对应的索引值为cf 28 00 00 3f 96 03 00 （即：cf 28 00 00 = 10447 ；3f 96 03 00 = 235071）
            postgres@[local]:5432 test# select ctid,* from tb_bloom_c where ctid='(50008,111)';
            +-------------+--------+--------+-------+--------+--------+--------+--------+--------+--------+--------+
            |    ctid     |   i1   |   i2   |  i3   |   i4   |   i5   |   i6   |   i7   |   i8   |   i9   |  i10   |
            +-------------+--------+--------+-------+--------+--------+--------+--------+--------+--------+--------+
            | (50008,111) | 606646 | 524184 | 10447 | 503115 | 900255 | 582993 | 776955 | 235071 | 124957 | 495598 |
            +-------------+--------+--------+-------+--------+--------+--------+--------+--------+--------+--------+
            (1 row)
        i3=10447  i8=235071 与上述索引一致
        
5. 最后btpo_flags=3 表示该页既是root page也是leaf page. 此种情况只存在0级结构中。
