pageinspect 查看BTREE索引结构

1. 添加pageinspect拓展
    create extension pageinspect;
    
2. 创建测试表，并创建一个多列组合索引
    select count(1) from tb_bloom_c;
    +----------+
    |  count   |
    +----------+
    | 10000000 |
    +----------+
    (1 row)
    
    postgres@[local]:5432 test# \d+ tb_bloom_c
                       Table "public.tb_bloom_c"
    +--------+---------+-----------+---------+--------------+-------------+
    | Column |  Type   | Modifiers | Storage | Stats target | Description |
    +--------+---------+-----------+---------+--------------+-------------+
    | i1     | integer |           | plain   |              |             |
    | i2     | integer |           | plain   |              |             |
    | i3     | integer |           | plain   |              |             |
    | i4     | integer |           | plain   |              |             |
    | i5     | integer |           | plain   |              |             |
    | i6     | integer |           | plain   |              |             |
    | i7     | integer |           | plain   |              |             |
    | i8     | integer |           | plain   |              |             |
    | i9     | integer |           | plain   |              |             |
    | i10    | integer |           | plain   |              |             |
    +--------+---------+-----------+---------+--------------+-------------+
    Indexes:
        "btreeidx_i38" btree (i3, i8)
        
    postgres@[local]:5432 test# \di+ btreeidx_i38
                               List of relations
    +--------+--------------+-------+----------+------------+--------+-------------+
    | Schema |     Name     | Type  |  Owner   |   Table    |  Size  | Description |
    +--------+--------------+-------+----------+------------+--------+-------------+
    | public | btreeidx_i38 | index | postgres | tb_bloom_c | 214 MB |             |
    +--------+--------------+-------+----------+------------+--------+-------------+
    (1 row)
    
3. BTREE索引结构
    BTREE索引结构包含四部分，meta page、root page、branch page和leaf page.
    在一个索引结构中meta page和root page是必须存在的。
            *-----------*
            | meta page |           一个页来存储，只想root page的page id
            *-----------*
                  |
            *-----------*
            | root page |           
            *-----------*           0级结构（只有meta page和root page）
                  |
           *-------------*
           | branch page |          1级结构
           *-------------*          2级结构
                .....                 ...
                  |                 n级结构
            *-----------*
            | leaf page |
            *-----------*
            
4. 利用pageinspect拓展包来剖析BTREE索引
    查看索引概况：
        postgres@[local]:5432 test# select * from bt_metap('btreeidx_i38');
        +--------+---------+------+-------+----------+-----------+
        | magic  | version | root | level | fastroot | fastlevel |
        +--------+---------+------+-------+----------+-----------+
        | 340322 |       2 |  290 |     2 |      290 |         2 |
        +--------+---------+------+-------+----------+-----------+
        (1 row)
        由上述结果：root=290 表示root 的page id=290
                   level=2  表示为2级结构（即4种page都刚好存在）
                   
     查看索引root page概要信息：
        postgres@[local]:5432 test# select * from bt_page_stats('btreeidx_i38',290);
        +-------+------+------------+------------+---------------+-----------+-----------+-----------+-----------+------+------------+
        | blkno | type | live_items | dead_items | avg_item_size | page_size | free_size | btpo_prev | btpo_next | btpo | btpo_flags |
        +-------+------+------------+------------+---------------+-----------+-----------+-----------+-----------+------+------------+
        |   290 | r    |         97 |          0 |            15 |      8192 |      6216 |         0 |         0 |    2 |          2 |
        +-------+------+------------+------------+---------------+-----------+-----------+-----------+-----------+------+------------+
        (1 row)
        有上述结果：btpo=2 表示该页还不到最底层，（最底层为btpo=0 即该页中存储的ctid为heap page的地址）
                   btpo_flags=2 表示该页是root page
                   live_items=97 表示该root page指向97个branch page
                   
     查看索引root page指向的详细信息：
        postgres@[local]:5432 test# select * from bt_page_items('btreeidx_i38',290) limit 10;
        +------------+----------+---------+-------+------+-------------------------+
        | itemoffset |   ctid   | itemlen | nulls | vars |          data           |
        +------------+----------+---------+-------+------+-------------------------+
        |          1 | (3,1)    |       8 | f     | f    |                         |
        |          2 | (289,1)  |      16 | f     | f    | 87 28 00 00 54 c3 06 00 |
        |          3 | (575,1)  |      16 | f     | f    | dd 50 00 00 a9 84 0a 00 |
        |          4 | (860,1)  |      16 | f     | f    | 88 79 00 00 a7 86 02 00 |
        |          5 | (1145,1) |      16 | f     | f    | ee a1 00 00 ed 1a 0d 00 |
        |          6 | (1430,1) |      16 | f     | f    | 9c ca 00 00 ac cf 04 00 |
        |          7 | (1715,1) |      16 | f     | f    | 74 f3 00 00 de cb 01 00 |
        |          8 | (2000,1) |      16 | f     | f    | 37 1c 01 00 90 38 08 00 |
        |          9 | (2285,1) |      16 | f     | f    | 83 44 01 00 83 43 0b 00 |
        |         10 | (2570,1) |      16 | f     | f    | 48 6d 01 00 a6 67 06 00 |
        +------------+----------+---------+-------+------+-------------------------+
        (10 rows)
        
